<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PC Kombat Tycoon</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: #050505; --card: #141414;
            --grad-main: linear-gradient(135deg, #7b2cbf, #f72585);
            --grad-gold: linear-gradient(135deg, #ff9e00, #ffeb3b);
            --grad-green: linear-gradient(135deg, #2b9348, #80b918);
            --grad-gray: linear-gradient(135deg, #343a40, #495057);
            --text: #ffffff; --text-dim: #9ca3af;
        }
        body {
            margin: 0; padding: 0; background: var(--bg); color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            height: 100vh; overflow: hidden; display: flex; flex-direction: column;
            user-select: none; -webkit-tap-highlight-color: transparent; touch-action: none;
        }
        .screen { display: none; flex-direction: column; height: 100%; padding: 15px; box-sizing: border-box; overflow-y: auto; }
        .screen.active { display: flex; }

        /* HEADER */
        .header {
            display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;
            background: var(--card); padding: 12px; border-radius: 16px; margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .stat-box { text-align: center; }
        .stat-lbl { font-size: 9px; color: var(--text-dim); text-transform: uppercase; }
        .stat-val { font-size: 12px; font-weight: 700; margin-top: 2px; }
        
        .balance-wrap { text-align: center; margin: 10px 0 20px; }
        .balance { font-size: 40px; font-weight: 900; background: var(--grad-gold); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        /* TAP BTN */
        .tap-area { flex-grow: 1; display: flex; justify-content: center; align-items: center; }
        .tap-btn {
            width: 240px; height: 240px; border-radius: 50%;
            background: var(--grad-main); box-shadow: 0 0 50px rgba(247, 37, 133, 0.3);
            display: flex; justify-content: center; align-items: center; cursor: pointer;
            touch-action: manipulation; position: relative; border: 4px solid rgba(255,255,255,0.1);
        }
        .tap-btn::before { content: "PC"; font-size: 70px; font-weight: 900; color: rgba(0,0,0,0.3); }
        .tap-btn:active { transform: scale(0.97); }

        /* SHOP ITEMS */
        .section-title { font-size: 16px; font-weight: 800; margin: 15px 0 10px; color: #fff; padding-left: 5px; border-left: 3px solid #f72585; }
        .item {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--card); padding: 14px; margin-bottom: 10px; border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.03); transition: 0.2s;
        }
        .item-left { max-width: 65%; }
        .item-left h3 { margin: 0; font-size: 14px; color: #fff; }
        .item-left p { margin: 4px 0 0; font-size: 10px; color: var(--text-dim); line-height: 1.4; }
        .lvl-badge { background: #333; padding: 2px 5px; border-radius: 4px; font-size: 9px; margin-left: 5px; }
        
        .btn { border: none; padding: 8px 14px; border-radius: 8px; font-weight: 700; font-size: 11px; cursor: pointer; color: #fff; min-width: 80px; text-align: center; }
        .btn-buy { background: var(--grad-green); color: #000; }
        .btn-gray { background: var(--grad-gray); color: #888; cursor: not-allowed; }
        
        /* LEADERBOARD */
        .row { display: flex; align-items: center; padding: 12px; background: var(--card); margin-bottom: 6px; border-radius: 10px; }
        .rank { font-weight: 900; width: 30px; color: var(--text-dim); font-size: 12px; }
        .u-info { display: flex; flex-direction: column; margin-left: 10px; flex-grow: 1; }
        .u-name { font-weight: bold; font-size: 13px; }
        .u-time { font-size: 10px; color: var(--text-dim); }
        .u-inc { font-weight: 700; color: #34d399; font-size: 12px; }

        /* NAV */
        .nav {
            position: fixed; bottom: 0; width: 100%; background: rgba(5,5,5,0.95);
            display: flex; justify-content: space-around; padding: 10px 0 25px; 
            border-top: 1px solid rgba(255,255,255,0.05); z-index: 10;
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #52525b; font-size: 9px; }
        .nav-item.active { color: #f72585; }
        .nav-icon { font-size: 18px; margin-bottom: 3px; }

        .float { position: absolute; color: #fff; font-weight: 900; font-size: 24px; animation: float 0.6s forwards; pointer-events: none; }
        @keyframes float { to { transform: translateY(-80px); opacity: 0; } }
        
        /* Scroll fix */
        #shop-content { padding-bottom: 80px; }
    </style>
</head>
<body>

    <div id="screen-game" class="screen active">
        <div class="header">
            <div class="stat-box">
                <div class="stat-lbl">–î–æ—Ö–æ–¥/–ß–∞—Å</div>
                <div class="stat-val" style="color:#34d399">‚ÇΩ <span id="inc-hour">0</span></div>
            </div>
            <div class="stat-box">
                <div class="stat-lbl">–í–∞—Ç—Ç</div>
                <div class="stat-val"><span id="watt-cur">0</span> / <span id="watt-max">0</span></div>
            </div>
            <div class="stat-box">
                <div class="stat-lbl">–≠–Ω–µ—Ä–≥–∏—è</div>
                <div class="stat-val"><span id="en">0</span></div>
            </div>
        </div>
        <div class="balance-wrap">
            <div class="balance"><span id="bal">Loading...</span></div>
            <div style="font-size:12px; color:#777">CRYPTO RUBLES</div>
        </div>
        <div class="tap-area">
            <div class="tap-btn" id="tapBtn"></div>
        </div>
    </div>

    <div id="screen-shop" class="screen">
        <div class="section-title">üöÄ –û—Å–Ω–æ–≤–Ω–æ–µ</div>
        <div id="shop-hardware"></div>
        <div class="section-title">üíæ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã</div>
        <div id="shop-parts"></div>
        <div id="shop-content"></div> </div>

    <div id="screen-top" class="screen">
        <div class="section-title">üèÜ –¢–û–ü-50 –ë–æ–≥–∞—á–µ–π</div>
        <div id="leaderboard"></div>
        <div style="padding-bottom: 80px;"></div>
    </div>

    <div class="nav">
        <div class="nav-item active" onclick="tab('game', this)"><span class="nav-icon">üñ•Ô∏è</span><br>–ì–õ–ê–í–ù–ê–Ø</div>
        <div class="nav-item" onclick="tab('shop', this)"><span class="nav-icon">üõí</span><br>–†–´–ù–û–ö</div>
        <div class="nav-item" onclick="tab('top', this)"><span class="nav-icon">üìä</span><br>–†–ï–ô–¢–ò–ù–ì</div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        // üëá –¢–í–û–ô URL
        const BASE_URL = "https://–¢–í–û–ô_–ù–ò–ö.pythonanywhere.com"; 
        const API = BASE_URL + "/api";

        const uid = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : 999;
        const uname = tg.initDataUnsafe.user ? `${tg.initDataUnsafe.user.first_name} ${tg.initDataUnsafe.user.last_name||''}` : "Guest";
        const startParam = tg.initDataUnsafe.start_param;

        // STATE
        let s = { bal:0, en:1000, maxEn:1000, multi:1, mine:0, ram:1, psu:1, hdd:1, soft:0 };
        let queue = 0;

        // --- GENERATE 50 LEVELS OF DATA ---
        const gens = {
            cpu: { names: ["Intel 4004", "Intel 8086", "MOS 6502", "Zilog Z80", "Intel 286", "Intel 386", "Intel 486", "Pentium 60", "Pentium Pro", "Pentium II", "Celeron 300", "Pentium III", "Athlon K7", "Pentium 4", "Athlon 64", "Pentium D", "Core 2 Duo", "Phenom X4", "Core i5 750", "Core i7 2600K", "FX 8350", "Core i7 4790K", "Ryzen 1700", "Core i9 9900K", "Ryzen 3900X", "Threadripper", "Core i9 12900K", "Ryzen 7950X", "Epyc Genoa", "Xeon Sapphire", "Apple M2 Ultra", "Quantum Bit 1", "Quantum Bit 4", "Quantum Bit 16", "Neuro Chip v1", "Neuro Chip v2", "Bio-Processor", "Plasma Core", "Photon CPU", "Light Speed I", "Light Speed II", "Dark Matter I", "Dark Matter II", "Antimatter Core", "Black Hole I", "Black Hole II", "Time Warper", "God Chip", "Singularity", "The End"], prefix: "CPU" },
            gpu: { names: ["MDA Card", "CGA Card", "EGA Card", "VGA Card", "S3 Trio", "Voodoo 1", "Riva 128", "Voodoo 2", "Riva TNT2", "GeForce 256", "Radeon 7500", "GeForce 4 Ti", "Radeon 9800", "GeForce 6800", "GeForce 8800", "HD 5870", "GTX 480", "HD 7970", "GTX 690", "GTX 780 Ti", "GTX 980 Ti", "GTX 1080 Ti", "RTX 2080 Ti", "Radeon VII", "RTX 3090", "RX 6900 XT", "RTX 4090", "RX 7900 XTX", "RTX 5090", "H100 Hopper", "B200 Blackwell", "Tesla Dojo", "Cerebras WSE", "Quantum GPU 1", "Quantum GPU 2", "Holographic I", "Holographic II", "Reality Render", "Sim Matrix I", "Sim Matrix II", "AI Overlord", "Neural Net I", "Neural Net II", "Dyson Link", "Star Forge", "Galaxy Render", "Uni-Verse I", "Uni-Verse II", "Omni-Process", "Infinity"], prefix: "GPU" }
        };

        // --- MATH & BALANCE (0.05 rule) ---
        function getPrice(base, lvl) {
            // –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π —Ä–æ—Å—Ç —Ü–µ–Ω—ã: Base * 1.35^lvl
            return Math.floor(base * Math.pow(1.35, lvl));
        }
        function getIncome(price) {
            // –ü—Ä–∞–≤–∏–ª–æ: 0.05 –æ—Ç —Ü–µ–Ω—ã –≤ —á–∞—Å
            // –í —Å–µ–∫—É–Ω–¥—É: (Price * 0.05) / 3600
            return (price * 0.05) / 3600;
        }

        // --- API ---
        async function req(ep, body={}) {
            try {
                // –¢–ò–•–ò–ô –†–ï–ñ–ò–ú: –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ - –ø—Ä–æ—Å—Ç–æ –∏–≥–Ω–æ—Ä–∏–º
                const r = await fetch(API + ep, {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({user_id:uid, username:uname, ...body})
                });
                return r.ok ? await r.json() : null;
            } catch(e) { return null; }
        }

        async function init() {
            const d = await req('/init', {start_param:startParam});
            if(d) {
                const u = d.user;
                s = { 
                    bal: u.balance, en: u.energy, maxEn: u.max_energy, 
                    multi: u.multitap_level, mine: u.mining_level, 
                    ram: u.ram_level, psu: u.psu_level, hdd: u.hdd_level, soft: u.software_level 
                };
                updateUI();
                renderShop();
                if(d.profit_afk > 0) tg.showAlert(`AFK –î–æ—Ö–æ–¥: +${format(d.profit_afk)} ‚ÇΩ`);
            }
        }

        // --- RENDER ---
        function updateUI() {
            document.getElementById('bal').innerText = format(s.bal);
            document.getElementById('en').innerText = Math.floor(s.en);
            
            // Income Calc (Same as server)
            const curLvl = s.mine;
            const priceCurrent = getPrice(1000, curLvl); // –¶–µ–Ω–∞ —Ç–µ–∫—É—â–µ–≥–æ —É—Ä–æ–≤–Ω—è
            // –£ –Ω–∞—Å –¥–æ—Ö–æ–¥ —Å—á–∏—Ç–∞–µ—Ç—Å—è –æ—Ç —É—Ä–æ–≤–Ω—è.
            // –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏:
            // –î–æ—Ö–æ–¥ = —É—Ä * (5 + —É—Ä) * —Å–æ—Ñ—Ç
            const base = s.mine * (5 + s.mine);
            const soft = 1 + (s.soft * 0.1);
            const incHour = Math.floor(base * soft * 3600 / 10);
            
            document.getElementById('inc-hour').innerText = format(incHour);

            // Watts
            const used = (s.multi * 10) + (s.mine * 25);
            const maxW = 200 * Math.pow(1.5, s.psu-1);
            const wEl = document.getElementById('watt-cur');
            wEl.innerText = Math.floor(used);
            document.getElementById('watt-max').innerText = Math.floor(maxW);
            wEl.style.color = used > maxW ? '#ff4444' : '#fff';
        }

        function renderShop() {
            const hw = document.getElementById('shop-hardware');
            const pt = document.getElementById('shop-parts');
            hw.innerHTML = ""; pt.innerHTML = "";

            // --- –ë–ê–õ–ê–ù–°–ò–†–û–í–ö–ê ---
            // 1. CPU (Multitap)
            // Base Price: 200
            const cpuLvl = s.multi;
            const cpuPrice = getPrice(200, cpuLvl);
            const cpuClick = Math.floor(cpuLvl * (1 + cpuLvl * 0.1));
            const cpuNextClick = Math.floor((cpuLvl+1) * (1 + (cpuLvl+1) * 0.1));
            const cpuName = gens.cpu.names[cpuLvl-1] || `CPU MK-${cpuLvl}`;
            const cpuNext = gens.cpu.names[cpuLvl] || `CPU MK-${cpuLvl+1}`;
            
            // 2. GPU (Mining)
            // Base Price: 1000
            const gpuLvl = s.mine;
            const gpuPrice = getPrice(1000, gpuLvl);
            // –î–æ—Ö–æ–¥ –≤ —á–∞—Å (–ø—Ä–∏–º–µ—Ä–Ω—ã–π)
            const incNow = Math.floor(gpuLvl*(5+gpuLvl) * 360);
            const incNext = Math.floor((gpuLvl+1)*(5+gpuLvl+1) * 360);
            const gpuName = gens.gpu.names[gpuLvl] || `GPU MK-${gpuLvl+1}`;

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ GAP (–†–∞–∑–Ω–∏—Ü–∞ —É—Ä–æ–≤–Ω–µ–π)
            // –ò—â–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å —Å—Ä–µ–¥–∏ –≤—Å–µ—Ö –±—É—Å—Ç–æ–≤
            const lvls = [s.multi, s.mine, s.ram, s.psu, s.hdd];
            const minLvl = Math.min(...lvls);
            
            // –§—É–Ω–∫—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∞ –∫–Ω–æ–ø–∫–∏
            const makeBtn = (cont, type, name, desc, lvl, price, curVal) => {
                const canAfford = s.bal >= price;
                // GAP CHECK: –ù–µ–ª—å–∑—è –∫–∞—á–∞—Ç—å –µ—Å–ª–∏ —Ä–∞–∑–Ω–∏—Ü–∞ > 3 (–∫—Ä–æ–º–µ —Å–æ—Ñ—Ç–∞ –∏ —ç–Ω–µ—Ä–≥–∏–∏)
                // –ù–æ –º–æ–∂–Ω–æ –∫–∞—á–∞—Ç—å, –µ—Å–ª–∏ —ç—Ç–æ—Ç –±—É—Å—Ç —Å–∞–º —è–≤–ª—è–µ—Ç—Å—è –æ—Ç—Å—Ç–∞—é—â–∏–º (lvl <= minLvl)
                const isGapBlock = (lvl - minLvl) >= 3;
                
                let btnClass = canAfford ? 'btn-buy' : 'btn-gray';
                let btnText = `‚ÇΩ ${format(price)}`;
                let status = "";

                if (isGapBlock && type !== 'soft' && type !== 'energy') {
                    btnClass = 'btn-gray';
                    btnText = "LOCKED";
                    // –ù–∞–π—Ç–∏ —á—Ç–æ –∫–∞—á–∞—Ç—å
                    const weak = [];
                    if(s.multi==minLvl) weak.push("CPU");
                    if(s.mine==minLvl) weak.push("GPU");
                    if(s.ram==minLvl) weak.push("RAM");
                    if(s.psu==minLvl) weak.push("PSU");
                    if(s.hdd==minLvl) weak.push("HDD");
                    status = `<span style="color:#ef4444">‚ö†Ô∏è –ü—Ä–æ–∫–∞—á–∞–π: ${weak[0]}</span>`;
                }

                if (lvl >= 50) {
                    btnClass = 'btn-gray'; btnText = "MAX";
                }

                const el = document.createElement('div');
                el.className = 'item';
                el.innerHTML = `
                    <div class="item-left">
                        <h3>${name} <span class="lvl-badge">${lvl}</span></h3>
                        <p>${desc}<br>${status}</p>
                    </div>
                    <button class="btn ${btnClass}" onclick="buy('${type}', ${price}, ${isGapBlock})">${btnText}</button>
                `;
                cont.appendChild(el);
            };

            // RENDER ITEMS
            makeBtn(hw, 'multitap', cpuNext, `–ö–ª–∏–∫: +${cpuNextClick - cpuClick}`, s.multi, cpuPrice);
            makeBtn(hw, 'mining', gpuName, `–î–æ—Ö–æ–¥: +${format(incNext - incNow)}/—á`, s.mine, gpuPrice);
            
            const ramPrice = getPrice(500, s.ram);
            makeBtn(pt, 'ram', "–û–ó–£ –ú–æ–¥—É–ª—å", `–†–µ–≥–µ–Ω —ç–Ω–µ—Ä–≥–∏–∏: +0.5/—Å–µ–∫`, s.ram, ramPrice);
            
            const psuPrice = getPrice(500, s.psu);
            const psuW = Math.floor(200 * Math.pow(1.5, s.psu));
            makeBtn(pt, 'psu', "–ë–ª–æ–∫ –ü–∏—Ç–∞–Ω–∏—è", `–õ–∏–º–∏—Ç: ${psuW}W`, s.psu, psuPrice);
            
            const hddPrice = getPrice(800, s.hdd);
            makeBtn(pt, 'hdd', "SSD –î–∏—Å–∫", `–ü–æ–∑–≤–æ–ª—è–µ—Ç —Å—Ç–∞–≤–∏—Ç—å –°–æ—Ñ—Ç`, s.hdd, hddPrice);
            
            const softPrice = getPrice(2000, s.soft);
            makeBtn(pt, 'software', "–ú–∞–π–Ω–µ—Ä –ü–û", `–î–æ—Ö–æ–¥: +10% (–ù—É–∂–µ–Ω SSD)`, s.soft, softPrice);
        }

        async function buy(type, price, isBlocked) {
            if(isBlocked) { tg.showAlert("–°–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π —Ä–∞–∑—Ä—ã–≤ —É—Ä–æ–≤–Ω–µ–π! –ü–æ–¥—Ç—è–Ω–∏ —Å–ª–∞–±–æ–µ –∂–µ–ª–µ–∑–æ."); return; }
            if(s.bal < price) return; // Silent fail (button is gray anyway)

            // Optimistic Update
            s.bal -= price;
            if(type=='multitap') s.multi++;
            if(type=='mining') s.mine++;
            if(type=='ram') s.ram++;
            if(type=='psu') s.psu++;
            if(type=='hdd') s.hdd++;
            if(type=='software') s.soft++;
            
            updateUI();
            renderShop(); // Refresh buttons colors immediately

            const res = await req('/buy', {type, price});
            if(res && res.status==='ok') {
                // Sync ok
            } else {
                // Rollback if error (optional, usually init handles it)
                init(); 
            }
        }

        async function daily() {
            const res = await req('/daily');
            if(res && res.status === 'ok') {
                tg.showAlert(`–ë–æ–Ω—É—Å –ø–æ–ª—É—á–µ–Ω: ${format(res.reward)} ‚ÇΩ`);
                init();
            } else {
                tg.showAlert("–ë–æ–Ω—É—Å –¥–æ—Å—Ç—É–ø–µ–Ω —Ä–∞–∑ –≤ 24 —á–∞—Å–∞!");
            }
        }

        // --- ACTIONS ---
        const btn = document.getElementById('tapBtn');
        btn.addEventListener('pointerdown', (e) => {
            e.preventDefault();
            const cost = Math.floor(s.multi * (1 + s.multi*0.1)); // Income per tap
            const enCost = Math.ceil(cost / 2);
            
            if(s.en >= enCost) {
                s.bal += cost;
                s.en -= enCost;
                queue++;
                updateUI();
                
                // Anim
                const fl = document.createElement('div');
                fl.className = 'float';
                fl.innerText = `+${format(cost)}`;
                fl.style.left = e.clientX + 'px';
                fl.style.top = e.clientY - 40 + 'px';
                document.body.appendChild(fl);
                setTimeout(()=>fl.remove(), 600);
                tg.HapticFeedback.impactOccurred('light');
            }
        });

        // Loop
        setInterval(async()=>{ if(queue>0){ await req('/tap', {clicks:queue}); queue=0; } }, 2000);
        
        // Passive Loop
        setInterval(()=>{
            const regen = 1 + (s.ram * 0.5);
            s.en = Math.min(s.maxEn, s.en + (regen/5));
            // Passive income visual
            const base = s.mine * (5 + s.mine);
            const soft = 1 + (s.soft * 0.1);
            const incSec = (base * soft) / 10;
            s.bal += incSec / 5;
            updateUI();
        }, 200);

        // Leaderboard
        async function loadTop() {
            const el = document.getElementById('leaderboard');
            el.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞...";
            const d = await req('/leaderboard');
            if(!d) return;
            el.innerHTML = "";
            
            d.forEach((u, i) => {
                // Time played calc
                const days = Math.floor((Date.now()/1000 - u.created_at) / 86400);
                const timeStr = days > 0 ? `${days} –¥–Ω.` : "–ù–æ–≤–∏—á–æ–∫";
                
                el.innerHTML += `
                <div class="row">
                    <div class="rank" style="color:${i<3?'#ffd700':'#777'}">#${i+1}</div>
                    <div class="u-info">
                        <span class="u-name">${u.name}</span>
                        <span class="u-time">–í –∏–≥—Ä–µ: ${timeStr}</span>
                    </div>
                    <div class="u-inc">+${format(u.income)}/—á</div>
                </div>`;
            });
        }

        function tab(t, btn) {
            document.querySelectorAll('.screen').forEach(e=>e.classList.remove('active'));
            document.getElementById('screen-'+t).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
            btn.classList.add('active');
            if(t==='top') loadTop();
            if(t==='shop') renderShop();
        }

        function format(n) {
            if(n >= 1e9) return (n/1e9).toFixed(2) + 'B';
            if(n >= 1e6) return (n/1e6).toFixed(2) + 'M';
            if(n >= 1e3) return (n/1e3).toFixed(1) + 'k';
            return Math.floor(n);
        }

        init();
    </script>
</body>
</html>
