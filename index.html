<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zolo Kombat 2.0</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: #0d1117;
            --card-bg: #161b22;
            --accent-gold: #ffd700;
            --accent-green: #2ea043;
            --accent-blue: #1f6feb;
            --text-primary: #f0f6fc;
            --text-secondary: #8b949e;
        }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, Roboto, Helvetica, Arial, sans-serif;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            user-select: none;
        }

        /* –≠–∫—Ä–∞–Ω—ã (–í–∫–ª–∞–¥–∫–∏) */
        .screen { display: none; height: 100%; flex-direction: column; padding: 15px; overflow-y: auto; }
        .screen.active { display: flex; }

        /* HEADER STATS */
        .stats-grid {
            display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;
            background: var(--card-bg); padding: 15px; border-radius: 15px; margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }
        .stat-item { text-align: center; }
        .stat-label { font-size: 10px; color: var(--text-secondary); text-transform: uppercase; }
        .stat-val { font-size: 14px; font-weight: bold; color: var(--accent-gold); }

        /* BIG BALANCE */
        .balance-container { text-align: center; margin: 20px 0; }
        .balance-val { font-size: 48px; font-weight: 800; text-shadow: 0 0 15px rgba(255, 215, 0, 0.3); }

        /* TAP AREA */
        .tap-area { flex-grow: 1; display: flex; justify-content: center; align-items: center; position: relative; }
        .tap-btn {
            width: 260px; height: 260px;
            background-image: url('https://imgur.com/a/ReGSIoj');
            background-size: cover; border-radius: 50%;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.2);
            transition: transform 0.05s;
            cursor: pointer; border: 5px solid rgba(255,255,255,0.1);
        }
        .tap-btn:active { transform: scale(0.95); }

        /* ENERGY */
        .energy-bar-container { height: 10px; background: #333; border-radius: 5px; margin: 10px 20px; overflow: hidden; }
        .energy-fill { height: 100%; background: linear-gradient(90deg, #f39c12, #f1c40f); width: 100%; transition: width 0.2s; }

        /* UPGRADES LIST */
        .upgrade-item {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--card-bg); padding: 15px; margin-bottom: 10px; border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.05); transition: 0.2s;
        }
        .upgrade-info h4 { margin: 0; font-size: 16px; }
        .upgrade-info p { margin: 5px 0 0; font-size: 12px; color: var(--text-secondary); }
        
        .buy-btn {
            padding: 8px 16px; border-radius: 8px; font-weight: bold; font-size: 13px;
            background: #333; color: #777; border: none; cursor: default;
            transition: 0.3s;
        }
        /* –ö–æ–≥–¥–∞ –¥–µ–Ω–µ–≥ —Ö–≤–∞—Ç–∞–µ—Ç - –∫–Ω–æ–ø–∫–∞ —Ü–≤–µ—Ç–Ω–∞—è */
        .buy-btn.can-buy {
            background: linear-gradient(45deg, var(--accent-green), #238636);
            color: white; cursor: pointer;
            box-shadow: 0 0 10px rgba(46, 160, 67, 0.4);
        }
        .buy-btn.can-buy:active { transform: scale(0.95); }

        /* LEADERBOARD & FRIENDS */
        .list-item {
            display: flex; justify-content: space-between; padding: 15px;
            background: var(--card-bg); margin-bottom: 8px; border-radius: 10px;
            border-bottom: 1px solid #333;
        }
        .rank-num { font-weight: bold; color: var(--accent-gold); width: 30px; }
        .daily-btn {
            width: 100%; padding: 20px; background: linear-gradient(45deg, #7f00ff, #e100ff);
            border: none; border-radius: 15px; color: white; font-weight: bold; font-size: 18px;
            margin-bottom: 20px; cursor: pointer; opacity: 0.5; pointer-events: none;
        }
        .daily-btn.active { opacity: 1; pointer-events: auto; animation: pulse 2s infinite; }

        @keyframes pulse { 0% {box-shadow: 0 0 0 0 rgba(225, 0, 255, 0.4);} 70% {box-shadow: 0 0 0 10px rgba(225, 0, 255, 0);} 100% {box-shadow: 0 0 0 0 rgba(225, 0, 255, 0);} }

        /* NAVIGATION */
        .bottom-nav {
            display: flex; justify-content: space-around; background: #010409;
            padding: 15px 0 25px; border-top: 1px solid #30363d;
        }
        .nav-btn {
            display: flex; flex-direction: column; align-items: center; color: var(--text-secondary);
            font-size: 10px; cursor: pointer; transition: 0.2s;
        }
        .nav-btn.active { color: var(--text-primary); transform: scale(1.1); }
        .nav-icon { font-size: 24px; margin-bottom: 5px; }

        /* FLOATING TEXT */
        .float-text { position: absolute; color: white; font-weight: bold; font-size: 24px; animation: floatUp 0.8s forwards; pointer-events: none; }
        @keyframes floatUp { to { transform: translateY(-100px); opacity: 0; } }

        #error-toast {
            position: fixed; top: 10px; left: 50%; transform: translateX(-50%);
            background: #ff4b4b; color: white; padding: 10px 20px; border-radius: 20px;
            font-size: 12px; display: none; z-index: 100;
        }
    </style>
</head>
<body>

    <div id="error-toast">Connection Lost</div>

    <div id="screen-game" class="screen active">
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-label">–î–æ—Ö–æ–¥ –≤ —á–∞—Å</div>
                <div class="stat-val">+<span id="mining-stat">0</span></div>
            </div>
            <div class="stat-item">
                <div class="stat-label">–≠–Ω–µ—Ä–≥–∏—è</div>
                <div class="stat-val"><span id="energy">1500</span></div>
            </div>
            <div class="stat-item">
                <div class="stat-label">–ö–ª–∏–∫</div>
                <div class="stat-val">x<span id="multitap-stat">1</span></div>
            </div>
        </div>

        <div class="balance-container">
            <div class="balance-val" id="balance">0</div>
        </div>

        <div class="tap-area">
            <div class="tap-btn" id="tapBtn"></div>
        </div>

        <div class="energy-bar-container">
            <div class="energy-fill" id="energy-bar"></div>
        </div>
    </div>

    <div id="screen-earn" class="screen">
        <h2>üî• –ü—Ä–æ–∫–∞—á–∫–∞</h2>
        
        <button id="daily-btn" class="daily-btn" onclick="claimDaily()">üéÅ –ó–∞–±—Ä–∞—Ç—å –Ω–∞–≥—Ä–∞–¥—É (50k)</button>

        <div class="upgrade-item">
            <div class="upgrade-info">
                <h4>üöÄ Multitap</h4>
                <p>–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –¥–æ—Ö–æ–¥ –∑–∞ –∫–ª–∏–∫</p>
            </div>
            <button class="buy-btn" id="btn-multi" onclick="buy('multitap')">200</button>
        </div>

        <div class="upgrade-item">
            <div class="upgrade-info">
                <h4>‚õèÔ∏è Mining</h4>
                <p>–ü–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥ –≤ —Å–µ–∫—É–Ω–¥—É</p>
            </div>
            <button class="buy-btn" id="btn-mine" onclick="buy('mining')">1000</button>
        </div>
    </div>

    <div id="screen-social" class="screen">
        <h2>ü§ù –†–µ—Ñ–µ—Ä–∞–ª—ã</h2>
        <div style="background: var(--card-bg); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
            <p>–ü—Ä–∏–≥–ª–∞—Å–∏ –¥—Ä—É–≥–∞ –∏ –ø–æ–ª—É—á–∏ <b>5,000 –º–æ–Ω–µ—Ç</b>!</p>
            <button class="buy-btn can-buy" style="width:100%" onclick="inviteFriend()">–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞</button>
        </div>

        <h2>üèÜ –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤</h2>
        <div id="leaderboard-list">
            <div style="text-align:center; color:#777">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-btn active" onclick="switchTab('game', this)">
            <div class="nav-icon">üêπ</div>
            <div>–ò–≥—Ä–∞</div>
        </div>
        <div class="nav-btn" onclick="switchTab('earn', this)">
            <div class="nav-icon">üöÄ</div>
            <div>–ë—É—Å—Ç—ã</div>
        </div>
        <div class="nav-btn" onclick="switchTab('social', this)">
            <div class="nav-icon">üë•</div>
            <div>–î—Ä—É–∑—å—è</div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // ==========================================
        // üëá –í–°–¢–ê–í–¨ –°–í–û–ô –ê–î–†–ï–° –ù–ò–ñ–ï üëá
        const SERVER_URL = "https://aboba1234.pythonanywhere.com/"; 
        // ==========================================

        const userId = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : 111;
        // –ü–æ–ª—É—á–∞–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä (start_param)
        const startParam = tg.initDataUnsafe.start_param || null;

        let gameState = { balance: 0, energy: 1500, multitap: 1, mining: 0 };
        let clicksQueue = 0;

        // UI –≠–ª–µ–º–µ–Ω—Ç—ã
        const els = {
            balance: document.getElementById('balance'),
            energy: document.getElementById('energy'),
            energyBar: document.getElementById('energy-bar'),
            multiStat: document.getElementById('multitap-stat'),
            mineStat: document.getElementById('mining-stat'),
            btnMulti: document.getElementById('btn-multi'),
            btnMine: document.getElementById('btn-mine'),
            dailyBtn: document.getElementById('daily-btn'),
            errorToast: document.getElementById('error-toast')
        };

        // --- API –§–£–ù–ö–¶–ò–Ø ---
        async function apiRequest(endpoint, body = {}) {
            try {
                const res = await fetch(`${SERVER_URL}${endpoint}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ user_id: userId, ...body })
                });

                // –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å 400 - —ç—Ç–æ –ª–æ–≥–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ (–Ω–µ—Ç –¥–µ–Ω–µ–≥), –∞ –Ω–µ —Å–µ—Ç–∏
                if (res.status === 400) {
                    const err = await res.json();
                    tg.showAlert(err.error || "–û—à–∏–±–∫–∞");
                    return null;
                }

                if (!res.ok) throw new Error("Network");
                
                els.errorToast.style.display = 'none';
                return await res.json();

            } catch (e) {
                console.error(e);
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–ª–∞—à–∫—É "Connection Lost"
                els.errorToast.style.display = 'block';
                return null;
            }
        }

        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
        async function initGame() {
            // –ü–µ—Ä–µ–¥–∞–µ–º start_param –¥–ª—è —Ä–µ—Ñ–µ—Ä–∞–ª–∫–∏
            const data = await apiRequest('/api/init', { start_param: startParam });
            if (data) {
                gameState = data;
                updateUI();
                
                // –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –Ω–∞–≥—Ä–∞–¥–∞
                if (data.can_claim_daily) {
                    els.dailyBtn.classList.add('active');
                    els.dailyBtn.innerText = "üéÅ –ó–ê–ë–†–ê–¢–¨ 50,000!";
                } else {
                    els.dailyBtn.classList.remove('active');
                    els.dailyBtn.innerText = "‚è≥ –ñ–¥–∏ 24—á";
                }

                if (data.profit_afk > 0) tg.showAlert(`–¢—ã —Å–ø–∞–ª, –∞ –ó–æ–ª–æ –∑–∞—Ä–∞–±–æ—Ç–∞–ª: +${data.profit_afk}`);
            }
        }

        // --- –¢–ê–ü ---
        document.getElementById('tapBtn').addEventListener('click', (e) => {
            if (gameState.energy > 0) {
                gameState.balance += gameState.multitap;
                gameState.energy--;
                clicksQueue++;
                updateUI();
                
                // –ê–Ω–∏–º–∞—Ü–∏—è
                const float = document.createElement('div');
                float.className = 'float-text';
                float.innerText = '+' + gameState.multitap;
                float.style.left = e.clientX + 'px';
                float.style.top = e.clientY - 50 + 'px';
                document.body.appendChild(float);
                setTimeout(() => float.remove(), 800);
                
                tg.HapticFeedback.impactOccurred('medium');
            }
        });

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–ª–∏–∫–æ–≤
        setInterval(async () => {
            if (clicksQueue > 0) {
                const toSend = clicksQueue; clicksQueue = 0;
                await apiRequest('/api/tap', { clicks: toSend });
            }
        }, 2000);

        // --- –ü–û–ö–£–ü–ö–ê ---
        async function buy(type) {
            // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
            let price = (type === 'multitap') ? 200 * gameState.multitap : 1000 * (gameState.mining + 1);
            if (gameState.balance < price) {
                tg.HapticFeedback.notificationOccurred('error');
                tg.showAlert("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –º–æ–Ω–µ—Ç!"); 
                return;
            }

            const res = await apiRequest('/api/buy', { type: type });
            if (res && res.status === 'ok') {
                tg.HapticFeedback.notificationOccurred('success');
                initGame(); // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
            }
        }

        // --- –ï–ñ–ï–î–ù–ï–í–ö–ê ---
        async function claimDaily() {
            const res = await apiRequest('/api/daily');
            if (res && res.status === 'ok') {
                tg.HapticFeedback.notificationOccurred('success');
                tg.showAlert("–ù–∞–≥—Ä–∞–¥–∞ –ø–æ–ª—É—á–µ–Ω–∞!");
                initGame();
            }
        }

        // --- –î–†–£–ó–¨–Ø –ò –¢–û–ü ---
        function inviteFriend() {
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å—Å—ã–ª–∫—É
            const link = `https://t.me/–¢–í–û–ô_–ë–û–¢?start=${userId}`;
            const text = "–ó–∞—Ö–æ–¥–∏ –≤ Zolo Kombat, —Ç–∞–ø–∞–π –∏ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π!";
            const url = `https://t.me/share/url?url=${encodeURIComponent(link)}&text=${encodeURIComponent(text)}`;
            tg.openTelegramLink(url);
        }

        async function loadLeaderboard() {
            try {
                const res = await fetch(`${SERVER_URL}/api/leaderboard`);
                const users = await res.json();
                const list = document.getElementById('leaderboard-list');
                list.innerHTML = "";
                users.forEach((u, i) => {
                    list.innerHTML += `
                        <div class="list-item">
                            <span class="rank-num">#${i+1}</span>
                            <span>ID: ${u.id}</span>
                            <span style="color:gold">${u.balance.toLocaleString()}</span>
                        </div>`;
                });
            } catch (e) { console.error(e); }
        }

        // --- –ò–ù–¢–ï–†–§–ï–ô–° ---
        function updateUI() {
            els.balance.innerText = gameState.balance.toLocaleString();
            els.energy.innerText = Math.floor(gameState.energy);
            els.multiStat.innerText = gameState.multitap;
            els.mineStat.innerText = (gameState.mining * 3600).toLocaleString();
            
            const pct = (gameState.energy / 1500) * 100;
            els.energyBar.style.width = pct + "%";

            // –õ–æ–≥–∏–∫–∞ –¶–í–ï–¢–ù–´–• –ö–ù–û–ü–û–ö
            updateBtn(els.btnMulti, 200 * gameState.multitap);
            updateBtn(els.btnMine, 1000 * (gameState.mining + 1));
        }

        function updateBtn(btn, price) {
            btn.innerText = price.toLocaleString();
            if (gameState.balance >= price) {
                btn.classList.add('can-buy');
            } else {
                btn.classList.remove('can-buy');
            }
        }

        function switchTab(tab, btn) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen-' + tab).classList.add('active');
            
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            if (tab === 'social') loadLeaderboard();
        }

        initGame();
        
        // –†–µ–≥–µ–Ω —ç–Ω–µ—Ä–≥–∏–∏ –≤–∏–∑—É–∞–ª
        setInterval(() => {
            if (gameState.energy < 1500) { gameState.energy++; updateUI(); }
        }, 1000);
    </script>
</body>
</html>

