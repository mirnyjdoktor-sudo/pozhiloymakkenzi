<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PC Kombat</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            /* –ù–û–í–ê–Ø –ü–ê–õ–ò–¢–†–ê */
            --bg: #09090b;
            --card: #18181b;
            --grad-main: linear-gradient(135deg, #6366f1, #a855f7, #ec4899);
            --grad-gold: linear-gradient(135deg, #f59e0b, #fbbf24);
            --grad-green: linear-gradient(135deg, #10b981, #34d399);
            --grad-red: linear-gradient(135deg, #ef4444, #f87171);
            --text: #ffffff;
            --text-dim: #71717a;
        }

        body {
            margin: 0; padding: 0; background: var(--bg); color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            height: 100vh; overflow: hidden; display: flex; flex-direction: column;
            user-select: none; -webkit-tap-highlight-color: transparent;
        }

        .screen { display: none; flex-direction: column; height: 100%; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        .screen.active { display: flex; }

        /* HEADER */
        .header {
            display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;
            background: var(--card); padding: 15px; border-radius: 16px; margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .stat-box { text-align: center; }
        .stat-lbl { font-size: 10px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; }
        .stat-val { font-size: 14px; font-weight: 700; margin-top: 4px; }
        
        .grad-text { background: var(--grad-main); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 900; }

        /* BALANCE */
        .balance-wrap { text-align: center; margin: 10px 0 30px; }
        .balance { font-size: 48px; font-weight: 900; letter-spacing: -1px; background: var(--grad-gold); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .curr { font-size: 16px; color: var(--text-dim); font-weight: bold; }

        /* TAP BUTTON (CSS ONLY - NO IMAGES) */
        .tap-area { flex-grow: 1; display: flex; justify-content: center; align-items: center; position: relative; }
        .tap-btn {
            width: 260px; height: 260px;
            border-radius: 50%;
            background: var(--grad-main);
            box-shadow: 0 0 60px rgba(168, 85, 247, 0.4);
            position: relative; cursor: pointer;
            transition: transform 0.05s;
            display: flex; justify-content: center; align-items: center;
        }
        .tap-btn::before {
            content: "PC"; font-size: 80px; font-weight: 900; color: rgba(255,255,255,0.2);
        }
        .tap-btn:active { transform: scale(0.95); }
        .tap-btn::after {
            content: ''; position: absolute; top: 10px; left: 10px; right: 10px; bottom: 10px;
            border-radius: 50%; border: 4px solid rgba(255,255,255,0.1);
        }

        /* ENERGY */
        .en-wrap { margin: 0 10px; }
        .en-bar-bg { height: 8px; background: #27272a; border-radius: 4px; overflow: hidden; margin-top: 5px; }
        .en-bar-fill { height: 100%; background: var(--grad-gold); width: 100%; transition: width 0.1s linear; }

        /* SHOP ITEMS */
        .section-title { font-size: 20px; font-weight: 800; margin: 20px 0 10px; color: #fff; }
        .item {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--card); padding: 16px; margin-bottom: 12px; border-radius: 14px;
            border: 1px solid rgba(255,255,255,0.03);
        }
        .item-left h3 { margin: 0; font-size: 15px; color: #fff; }
        .item-left p { margin: 4px 0 0; font-size: 11px; color: var(--text-dim); }
        .hl-val { color: #a855f7; font-weight: bold; }

        .btn {
            border: none; padding: 10px 18px; border-radius: 10px; font-weight: 700; font-size: 12px;
            cursor: pointer; min-width: 90px; color: #000; transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.95); }
        .btn-buy { background: var(--grad-green); }
        .btn-lock { background: #27272a; color: #555; pointer-events: none; }
        .btn-daily { width: 100%; background: var(--grad-main); color: #fff; font-size: 16px; padding: 20px; margin-bottom: 20px; }
        .btn-daily.cd { opacity: 0.5; pointer-events: none; background: #27272a; }

        /* LEADERBOARD */
        .row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 14px; background: var(--card); margin-bottom: 8px; border-radius: 12px;
        }
        .rank { font-weight: 900; width: 40px; color: var(--text-dim); }
        .rank.top { color: #facc15; }
        .inc { font-weight: 700; color: #34d399; }
        
        .my-rank {
            position: fixed; bottom: 80px; left: 20px; right: 20px;
            background: var(--grad-main); padding: 15px; border-radius: 12px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); font-weight: bold;
        }

        /* NAV */
        .nav {
            position: fixed; bottom: 0; width: 100%; background: rgba(9,9,11,0.9);
            backdrop-filter: blur(10px); display: flex; justify-content: space-around;
            padding: 12px 0 30px; border-top: 1px solid rgba(255,255,255,0.05); z-index: 10;
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #52525b; font-size: 10px; transition: 0.2s; }
        .nav-item.active { color: #fff; transform: translateY(-4px); }
        .nav-icon { font-size: 20px; margin-bottom: 4px; }

        .float { position: absolute; color: #fff; font-weight: 900; font-size: 24px; animation: float 0.8s forwards; pointer-events: none; }
        @keyframes float { to { transform: translateY(-100px); opacity: 0; } }
    </style>
</head>
<body>

    <div id="screen-game" class="screen active">
        <div class="header">
            <div class="stat-box">
                <div class="stat-lbl">–î–æ—Ö–æ–¥/–ß–∞—Å</div>
                <div class="stat-val" style="color:#34d399">‚ÇΩ <span id="inc-hour">0</span></div>
            </div>
            <div class="stat-box">
                <div class="stat-lbl">–ë–ü (–í–∞—Ç—Ç)</div>
                <div class="stat-val"><span id="watt-cur">0</span> / <span id="watt-max">0</span></div>
            </div>
            <div class="stat-box">
                <div class="stat-lbl">–†–∞–Ω–≥</div>
                <div class="stat-val grad-text">#<span id="my-rank-disp">-</span></div>
            </div>
        </div>

        <div class="balance-wrap">
            <div class="balance"><span id="bal">0</span></div>
            <div class="curr">–ö—Ä–∏–ø—Ç–æ—Ä—É–±–ª–µ–π</div>
        </div>

        <div class="tap-area">
            <div class="tap-btn" id="tapBtn"></div>
        </div>

        <div class="en-wrap">
            <div style="display:flex; justify-content:space-between; font-size:12px; color:#777; margin-bottom:5px;">
                <span>–≠–Ω–µ—Ä–≥–∏—è</span>
                <span><span id="en">0</span> / <span id="max-en">0</span></span>
            </div>
            <div class="en-bar-bg"><div class="en-bar-fill" id="en-bar"></div></div>
        </div>
        <div style="height: 80px;"></div>
    </div>

    <div id="screen-shop" class="screen">
        <button id="daily-btn" class="btn btn-daily" onclick="daily()">üéÅ –ó–∞–±—Ä–∞—Ç—å –±–æ–Ω—É—Å</button>
        
        <div class="section-title">üñ•Ô∏è –ñ–µ–ª–µ–∑–æ (–ë–∞–∑–∞)</div>
        <div id="shop-hardware"></div>

        <div class="section-title">üíø –°–æ—Ñ—Ç –∏ –ü–∞–º—è—Ç—å</div>
        <div id="shop-soft"></div>
        <div style="height: 80px;"></div>
    </div>

    <div id="screen-top" class="screen">
        <div class="section-title">üèÜ –ë–æ–≥–∞—Ç–µ–π—à–∏–µ –ú–∞–≥–Ω–µ—Ä—ã</div>
        <div id="leaderboard"></div>
        <div style="height: 140px;"></div>
    </div>
    
    <div id="rank-footer" class="my-rank" style="display:none">
        <span>–í—ã: <span id="my-name">User</span></span>
        <span>#<span id="footer-rank">999</span></span>
    </div>

    <div class="nav">
        <div class="nav-item active" onclick="tab('game', this)">
            <span class="nav-icon">üíª</span> –ü–ö
        </div>
        <div class="nav-item" onclick="tab('shop', this)">
            <span class="nav-icon">üõçÔ∏è</span> –ê–ø–≥—Ä–µ–π–¥
        </div>
        <div class="nav-item" onclick="tab('top', this)">
            <span class="nav-icon">üìä</span> –†–µ–π—Ç–∏–Ω–≥
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        // –í–°–¢–ê–í–¨ –°–í–û–ô URL
        const API = "https://–¢–í–û–ô_–ù–ò–ö.pythonanywhere.com/api"; 

        const user = tg.initDataUnsafe.user;
        const uid = user ? user.id : 123;
        const uname = user ? `${user.first_name} ${user.last_name||''}`.trim() : "Player";
        const startParam = tg.initDataUnsafe.start_param;

        // --- GAME DATA ---
        let s = { bal:0, en:1000, maxEn:1000, multi:1, mine:0, ram:1, psu:1, hdd:1, soft:0, rank:0 };
        let queue = 0;

        // --- DB (NAMES) ---
        const cpuDB = ["Intel 8086","Pentium 1","Pentium 4","Core 2 Duo","Core i3","Core i5","Core i7","Ryzen 7","Core i9","Threadripper","Epyc","Quantum I","Quantum II","Neuro Chip"];
        const gpuDB = ["No GPU","CGA","VGA","Riva TNT","GeForce 256","GTX 480","GTX 980","GTX 1080","RTX 2080","RTX 3090","RTX 4090","H100 Cluster","Dojo Super","Matrix GPU"];
        const psuDB = [100,250,400,600,800,1000,1500,2000,3000,5000,10000,50000,100000]; // Watts
        const ramDB = ["DIP","SIMM","DDR1","DDR2","DDR3","DDR4","DDR5","HBM2","HBM3","DNA Storage"];
        const hddDB = ["Floppy 1.44","HDD 40GB","HDD 500GB","SSD 120GB","SSD 1TB","NVMe 4TB","Cloud 1PB","Neural Net"]; // Limits Software level

        // --- CORE FUNCTIONS ---
        async function req(ep, body={}) {
            try {
                const r = await fetch(API + ep, {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({user_id:uid, username:uname, ...body})
                });
                if(!r.ok) return null;
                return await r.json();
            } catch(e) { return null; } // SILENT FAIL
        }

        async function init() {
            const d = await req('/init', {start_param:startParam});
            if(d) {
                const u = d.user;
                s = { 
                    bal: u.balance, en: u.energy, maxEn: u.max_energy,
                    multi: u.multitap_level, mine: u.mining_level,
                    ram: u.ram_level, psu: u.psu_level, 
                    hdd: u.hdd_level, soft: u.software_level,
                    rank: d.rank, last_daily: u.last_daily
                };
                draw();
                drawShop();
            }
        }

        // --- DRAWING ---
        function draw() {
            // Stats
            document.getElementById('bal').innerText = Math.floor(s.bal).toLocaleString();
            document.getElementById('en').innerText = Math.floor(s.en);
            document.getElementById('max-en').innerText = s.maxEn;
            document.getElementById('en-bar').style.width = (s.en/s.maxEn*100) + "%";
            document.getElementById('my-rank-disp').innerText = s.rank;

            // Watts Calculation
            const used = (s.multi * 10) + (s.mine * 20); // –§–µ–π–∫–æ–≤–∞—è —Ñ–æ—Ä–º—É–ª–∞ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è
            const maxW = psuDB[s.psu-1] || 999999;
            const wEl = document.getElementById('watt-cur');
            wEl.innerText = used;
            wEl.style.color = used > maxW ? '#ef4444' : '#fff';
            document.getElementById('watt-max').innerText = maxW;

            // Income
            const baseInc = s.mine * 5;
            const mult = 1 + (s.soft * 0.1);
            const hourInc = Math.floor(baseInc * mult * 3600);
            document.getElementById('inc-hour').innerText = hourInc.toLocaleString();

            // Daily Btn
            const db = document.getElementById('daily-btn');
            const now = Date.now()/1000;
            if(now - s.last_daily > 86400) {
                db.classList.remove('cd'); db.innerText = "üéÅ –ó–ê–ë–†–ê–¢–¨ –ë–û–ù–£–°";
            } else {
                db.classList.add('cd'); db.innerText = "‚è≥ –ñ–¥–∏ 24—á";
            }
        }

        function drawShop() {
            const hw = document.getElementById('shop-hardware');
            const sf = document.getElementById('shop-soft');
            hw.innerHTML = ""; sf.innerHTML = "";

            // PSU
            const psuIdx = s.psu-1;
            const psuPrice = Math.floor(500 * Math.pow(1.5, s.psu));
            addItem(hw, "‚ö° –ë–ª–æ–∫ –ø–∏—Ç–∞–Ω–∏—è", `${psuDB[psuIdx]}W ‚ûî ${psuDB[psuIdx+1]||'MAX'}W`, s.psu, psuPrice, 'psu');

            // CPU (Check PSU)
            const cpuUsed = ((s.multi+1)*10) + (s.mine*20);
            const psuMax = psuDB[s.psu-1];
            const cpuOk = cpuUsed <= psuMax;
            const cpuPrice = Math.floor(200 * Math.pow(1.5, s.multi));
            addItem(hw, "üíª –ü—Ä–æ—Ü–µ—Å—Å–æ—Ä", `${cpuDB[s.multi-1]||'Old'} ‚ûî ${cpuDB[s.multi]||'MAX'}`, s.multi, cpuPrice, 'multitap', cpuOk);

            // GPU (Check PSU)
            const gpuUsed = (s.multi*10) + ((s.mine+1)*20);
            const gpuOk = gpuUsed <= psuMax;
            const gpuPrice = Math.floor(1000 * Math.pow(1.4, s.mine));
            addItem(hw, "üéÆ –í–∏–¥–µ–æ–∫–∞—Ä—Ç–∞", `${gpuDB[s.mine]||'None'} ‚ûî ${gpuDB[s.mine+1]||'MAX'}`, s.mine, gpuPrice, 'mining', gpuOk);

            // RAM
            const ramPrice = Math.floor(500 * Math.pow(1.3, s.ram));
            addItem(sf, "üíæ –û–ó–£ (–†–µ–≥–µ–Ω)", `${ramDB[s.ram-1]} ‚ûî ${ramDB[s.ram]}`, s.ram, ramPrice, 'ram');

            // HDD (Limit for soft)
            const hddPrice = Math.floor(3000 * Math.pow(2.0, s.hdd));
            addItem(sf, "üíø –ñ–µ—Å—Ç–∫–∏–π –¥–∏—Å–∫", `${hddDB[s.hdd-1]} ‚ûî ${hddDB[s.hdd]}`, s.hdd, hddPrice, 'hdd');

            // SOFTWARE (Check HDD)
            // –î–æ–ø—É—Å—Ç–∏–º, –∫–∞–∂–¥—ã–π —É—Ä–æ–≤–µ–Ω—å HDD –ø–æ–∑–≤–æ–ª—è–µ—Ç +5 —É—Ä–æ–≤–Ω–µ–π —Å–æ—Ñ—Ç–∞
            const softLimit = s.hdd * 5;
            const softOk = s.soft < softLimit;
            const softPrice = Math.floor(5000 * Math.pow(1.8, s.soft));
            const softTxt = softOk ? "+10% –∫ –¥–æ—Ö–æ–¥—É" : "–ù–£–ñ–ï–ù HDD!";
            addItem(sf, "üìÄ –ú–∞–π–Ω–µ—Ä Soft", softTxt, s.soft, softPrice, 'software', softOk);

            // Energy
            const enPrice = Math.floor(1000 * (s.maxEn/1000));
            addItem(sf, "üîã –ë–∞—Ç–∞—Ä–µ—è", "+500 –ú–∞–∫—Å –≠–Ω–µ—Ä–≥–∏–∏", "", enPrice, 'energy');
        }

        function addItem(cont, title, desc, lvl, price, type, reqMet=true) {
            const div = document.createElement('div');
            div.className = 'item';
            
            let btnClass = 'btn btn-buy';
            let btnTxt = format(price);
            let action = `buy('${type}', ${price})`;

            if(!reqMet) {
                btnClass = 'btn btn-lock';
                btnTxt = "Locked";
            } else if(s.bal < price) {
                btnClass = 'btn btn-lock'; // Grey out
            }

            div.innerHTML = `
                <div class="item-left">
                    <h3>${title} <span style="font-size:10px; color:#555">LVL ${lvl}</span></h3>
                    <p>${desc} <br> <span class="hl-val">‚ÇΩ ${btnTxt}</span></p>
                </div>
                <button class="${btnClass}" onclick="${action}">–ö–£–ü–ò–¢–¨</button>
            `;
            cont.appendChild(div);
        }

        // --- ACTIONS ---
        async function buy(type, price) {
            if(s.bal < price) return;
            // Optimistic update
            s.bal -= price;
            draw();
            const res = await req('/buy', {type:type, price:price});
            if(res && res.status === 'ok') init(); // Full sync
        }

        async function daily() {
            const res = await req('/daily');
            if(res && res.status === 'ok') { init(); }
        }

        document.getElementById('tapBtn').addEventListener('click', (e)=>{
            const cost = s.multi; // –¢—Ä–∞—Ç–∞ = —É—Ä–æ–≤–Ω—é
            if(s.en >= cost) {
                s.bal += cost;
                s.en -= cost;
                queue++;
                draw();
                
                // Anim
                const el = document.createElement('div');
                el.className='float'; el.innerText=`+${cost}`;
                el.style.left=e.clientX+'px'; el.style.top=e.clientY-40+'px';
                document.body.appendChild(el);
                setTimeout(()=>el.remove(), 800);
                tg.HapticFeedback.impactOccurred('light');
            }
        });

        setInterval(async()=>{
            if(queue>0) {
                await req('/tap', {clicks:queue});
                queue=0;
            }
        }, 2000);

        // Passive simulation
        setInterval(()=>{
            const regen = 1 + (s.ram * 0.5);
            s.en = Math.min(s.maxEn, s.en + (regen/5));
            
            const baseInc = s.mine * 5;
            const mult = 1 + (s.soft * 0.1);
            s.bal += (baseInc * mult) / 5;
            
            draw();
        }, 200);

        // --- TABS & LEADERBOARD ---
        async function loadTop() {
            const lb = document.getElementById('leaderboard');
            lb.innerHTML = "<div style='text-align:center;color:#555'>–ó–∞–≥—Ä—É–∑–∫–∞...</div>";
            
            const d = await req('/leaderboard');
            if(!d) return;
            
            lb.innerHTML = "";
            d.forEach((u,i) => {
                const isMe = u.name === uname;
                lb.innerHTML += `
                    <div class="row" style="${isMe?'border:1px solid #a855f7':''}">
                        <div style="display:flex; align-items:center;">
                            <span class="rank ${i<3?'top':''}">${i+1}</span>
                            <span style="font-weight:bold; font-size:14px;">${u.name}</span>
                        </div>
                        <span class="inc">+${format(u.income)}/—á</span>
                    </div>`;
            });

            // Show footer rank
            document.getElementById('rank-footer').style.display = 'flex';
            document.getElementById('my-name').innerText = uname;
            document.getElementById('footer-rank').innerText = s.rank;
        }

        function tab(t, btn) {
            document.querySelectorAll('.screen').forEach(e=>e.classList.remove('active'));
            document.getElementById('screen-'+t).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
            btn.classList.add('active');
            if(t==='top') {
                loadTop();
            } else {
                document.getElementById('rank-footer').style.display = 'none';
            }
            if(t==='shop') drawShop();
        }

        function format(n) {
            if(n>=1000000) return (n/1000000).toFixed(2)+'M';
            if(n>=1000) return (n/1000).toFixed(1)+'k';
            return Math.floor(n);
        }

        init();
    </script>
</body>
</html>
