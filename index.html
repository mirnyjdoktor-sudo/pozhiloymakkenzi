<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PC Kombat</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: #09090b; --card: #18181b;
            --grad-main: linear-gradient(135deg, #6366f1, #a855f7, #ec4899);
            --grad-gold: linear-gradient(135deg, #f59e0b, #fbbf24);
            --grad-green: linear-gradient(135deg, #10b981, #34d399);
            --text: #ffffff; --text-dim: #71717a;
        }
        body {
            margin: 0; padding: 0; background: var(--bg); color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            height: 100vh; overflow: hidden; display: flex; flex-direction: column;
            user-select: none; -webkit-tap-highlight-color: transparent; touch-action: none;
        }
        .screen { display: none; flex-direction: column; height: 100%; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        .screen.active { display: flex; }

        /* HEADER & STATS */
        .header {
            display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;
            background: var(--card); padding: 15px; border-radius: 16px; margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .stat-box { text-align: center; }
        .stat-lbl { font-size: 10px; color: var(--text-dim); text-transform: uppercase; }
        .stat-val { font-size: 13px; font-weight: 700; margin-top: 4px; }
        
        .balance-wrap { text-align: center; margin: 10px 0 20px; }
        .balance { font-size: 42px; font-weight: 900; background: var(--grad-gold); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .curr { font-size: 14px; color: var(--text-dim); font-weight: bold; }

        /* TAP AREA */
        .tap-area { flex-grow: 1; display: flex; justify-content: center; align-items: center; position: relative; }
        .tap-btn {
            width: 250px; height: 250px; border-radius: 50%;
            background: var(--grad-main); box-shadow: 0 0 60px rgba(168, 85, 247, 0.4);
            position: relative; cursor: pointer; display: flex; justify-content: center; align-items: center;
            touch-action: manipulation;
        }
        .tap-btn::before { content: "PC"; font-size: 80px; font-weight: 900; color: rgba(255,255,255,0.2); }
        .tap-btn:active { transform: scale(0.96); transition: 0.05s; }

        .en-wrap { margin: 0 10px; }
        .en-bar-bg { height: 8px; background: #27272a; border-radius: 4px; overflow: hidden; margin-top: 5px; }
        .en-bar-fill { height: 100%; background: var(--grad-gold); width: 100%; transition: width 0.1s linear; }

        /* SHOP */
        .section-title { font-size: 18px; font-weight: 800; margin: 20px 0 10px; color: #fff; }
        .item {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--card); padding: 16px; margin-bottom: 12px; border-radius: 14px;
            border: 1px solid rgba(255,255,255,0.03);
        }
        .item-left h3 { margin: 0; font-size: 15px; color: #fff; }
        .item-left p { margin: 4px 0 0; font-size: 11px; color: var(--text-dim); }
        .btn { border: none; padding: 10px 18px; border-radius: 10px; font-weight: 700; font-size: 12px; cursor: pointer; color: #000; }
        .btn-buy { background: var(--grad-green); }
        .btn-lock { background: #27272a; color: #555; pointer-events: none; }
        .btn-daily { width: 100%; background: var(--grad-main); color: #fff; font-size: 16px; padding: 20px; margin-bottom: 20px; }
        .btn-daily.cd { opacity: 0.5; pointer-events: none; background: #27272a; }

        /* LEADERBOARD */
        .row { display: flex; justify-content: space-between; padding: 14px; background: var(--card); margin-bottom: 8px; border-radius: 12px; }
        .rank { font-weight: 900; width: 40px; color: var(--text-dim); }
        .rank.top { color: #facc15; }
        
        .my-rank {
            position: fixed; bottom: 80px; left: 20px; right: 20px;
            background: var(--grad-main); padding: 15px; border-radius: 12px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); font-weight: bold; z-index: 5;
        }

        .nav {
            position: fixed; bottom: 0; width: 100%; background: rgba(9,9,11,0.95);
            display: flex; justify-content: space-around; padding: 12px 0 25px; border-top: 1px solid rgba(255,255,255,0.05); z-index: 10;
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #52525b; font-size: 10px; }
        .nav-item.active { color: #fff; }
        .nav-icon { font-size: 20px; margin-bottom: 4px; }

        .float { position: absolute; color: #fff; font-weight: 900; font-size: 28px; animation: float 0.5s forwards; pointer-events: none; text-shadow: 0 0 5px rgba(0,0,0,0.5); }
        @keyframes float { to { transform: translateY(-80px) scale(1.5); opacity: 0; } }
        
        /* –ö–ù–û–ü–ö–ê –†–ï–ú–û–ù–¢–ê (–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –æ—à–∏–±–∫–µ) */
        #repair-btn {
            position: fixed; top: 10px; left: 50%; transform: translateX(-50%);
            background: #ef4444; color: white; padding: 10px 20px; border-radius: 20px;
            font-weight: bold; display: none; z-index: 100;
        }
    </style>
</head>
<body>
    <a id="repair-btn" href="#" target="_blank">üõ† –ü–û–ß–ò–ù–ò–¢–¨ –ò–ì–†–£</a>

    <div id="screen-game" class="screen active">
        <div class="header">
            <div class="stat-box">
                <div class="stat-lbl">–î–æ—Ö–æ–¥/–ß–∞—Å</div>
                <div class="stat-val" style="color:#34d399">‚ÇΩ <span id="inc-hour">0</span></div>
            </div>
            <div class="stat-box">
                <div class="stat-lbl">–ë–ü (–í–∞—Ç—Ç)</div>
                <div class="stat-val"><span id="watt-cur">0</span> / <span id="watt-max">0</span></div>
            </div>
            <div class="stat-box">
                <div class="stat-lbl">–†–∞–Ω–≥</div>
                <div class="stat-val">#<span id="my-rank-disp">-</span></div>
            </div>
        </div>
        <div class="balance-wrap">
            <div class="balance"><span id="bal">Loading</span></div>
            <div class="curr">–ö—Ä–∏–ø—Ç–æ—Ä—É–±–ª–µ–π</div>
        </div>
        <div class="tap-area">
            <div class="tap-btn" id="tapBtn"></div>
        </div>
        <div class="en-wrap">
            <div style="display:flex; justify-content:space-between; font-size:12px; color:#777; margin-bottom:5px;">
                <span>–≠–Ω–µ—Ä–≥–∏—è</span>
                <span><span id="en">0</span> / <span id="max-en">0</span></span>
            </div>
            <div class="en-bar-bg"><div class="en-bar-fill" id="en-bar"></div></div>
        </div>
        <div style="height: 80px;"></div>
    </div>

    <div id="screen-shop" class="screen">
        <button id="daily-btn" class="btn btn-daily" onclick="daily()">üéÅ –ó–∞–±—Ä–∞—Ç—å –±–æ–Ω—É—Å</button>
        <div class="section-title">üñ•Ô∏è –ñ–µ–ª–µ–∑–æ</div>
        <div id="shop-hardware"></div>
        <div class="section-title">üíø –°–æ—Ñ—Ç –∏ –ü–∞–º—è—Ç—å</div>
        <div id="shop-soft"></div>
        <div style="height: 80px;"></div>
    </div>

    <div id="screen-top" class="screen">
        <div class="section-title">üèÜ –ú–∞–≥–Ω–∞—Ç—ã</div>
        <div id="leaderboard"></div>
        <div style="height: 140px;"></div>
    </div>
    
    <div id="rank-footer" class="my-rank" style="display:none">
        <span>–í—ã: <span id="my-name">User</span></span>
        <span>#<span id="footer-rank">-</span></span>
    </div>

    <div class="nav">
        <div class="nav-item active" onclick="tab('game', this)"><span class="nav-icon">üíª</span> –ü–ö</div>
        <div class="nav-item" onclick="tab('shop', this)"><span class="nav-icon">üõçÔ∏è</span> –ê–ø–≥—Ä–µ–π–¥</div>
        <div class="nav-item" onclick="tab('top', this)"><span class="nav-icon">üìä</span> –†–µ–π—Ç–∏–Ω–≥</div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        // ==========================================
        // üëá –í–°–¢–ê–í–¨ –°–í–û–ô URL –¢–£–¢!
        const BASE_URL = "https://–¢–í–û–ô_–ù–ò–ö.pythonanywhere.com"; 
        const API = BASE_URL + "/api";
        // ==========================================

        // –ö–Ω–æ–ø–∫–∞ —Ä–µ–º–æ–Ω—Ç–∞ –≤–µ–¥–µ—Ç –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å–µ—Ä–≤–µ—Ä–∞
        document.getElementById('repair-btn').href = BASE_URL;

        const user = tg.initDataUnsafe.user;
        const uid = user ? user.id : 123;
        const uname = user ? `${user.first_name} ${user.last_name||''}`.trim() : "Player";
        const startParam = tg.initDataUnsafe.start_param;

        let s = { bal:0, en:1000, maxEn:1000, multi:1, mine:0, ram:1, psu:1, hdd:1, soft:0, rank:0 };
        let queue = 0;

        const cpuDB = ["Intel 8086","Pentium 1","Pentium 4","Core 2 Duo","Core i3","Core i5","Core i7","Ryzen 7","Core i9","Threadripper","Epyc","Quantum I","Quantum II","Neuro Chip"];
        const gpuDB = ["No GPU","CGA","VGA","Riva TNT","GeForce 256","GTX 480","GTX 980","GTX 1080","RTX 2080","RTX 3090","RTX 4090","H100 Cluster","Dojo Super","Matrix GPU"];
        const psuDB = [100,250,400,600,800,1000,1500,2000,3000,5000,10000,50000,100000];
        const ramDB = ["DIP","SIMM","DDR1","DDR2","DDR3","DDR4","DDR5","HBM2","HBM3","DNA Storage"];
        const hddDB = ["Floppy 1.44","HDD 40GB","HDD 500GB","SSD 120GB","SSD 1TB","NVMe 4TB","Cloud 1PB","Neural Net"];

        async function req(ep, body={}) {
            try {
                const r = await fetch(API + ep, {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({user_id:uid, username:uname, ...body})
                });
                if(!r.ok) return null;
                return await r.json();
            } catch(e) { return null; }
        }

        async function init() {
            const d = await req('/init', {start_param:startParam});
            if(d) {
                // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏—à–ª–∏ - —Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Ä–µ–º–æ–Ω—Ç–∞
                document.getElementById('repair-btn').style.display = 'none';
                const u = d.user;
                s = { 
                    bal: u.balance, en: u.energy, maxEn: u.max_energy, 
                    multi: u.multitap_level, mine: u.mining_level, 
                    ram: u.ram_level, psu: u.psu_level, 
                    hdd: u.hdd_level, soft: u.software_level, 
                    rank: d.rank, last_daily: u.last_daily 
                };
                draw(); drawShop();
            } else {
                // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Ä–µ–º–æ–Ω—Ç–∞
                document.getElementById('repair-btn').style.display = 'block';
                document.getElementById('bal').innerText = "Error";
            }
        }

        function draw() {
            document.getElementById('bal').innerText = Math.floor(s.bal).toLocaleString();
            document.getElementById('en').innerText = Math.floor(s.en);
            document.getElementById('max-en').innerText = s.maxEn;
            document.getElementById('en-bar').style.width = (s.en/s.maxEn*100) + "%";
            document.getElementById('my-rank-disp').innerText = s.rank;

            const used = (s.multi * 10) + (s.mine * 20);
            const maxW = psuDB[s.psu-1] || 999999;
            const wEl = document.getElementById('watt-cur');
            wEl.innerText = used; wEl.style.color = used > maxW ? '#ef4444' : '#fff';
            document.getElementById('watt-max').innerText = maxW;

            const baseInc = s.mine * 5;
            const mult = 1 + (s.soft * 0.1);
            document.getElementById('inc-hour').innerText = Math.floor(baseInc * mult * 3600).toLocaleString();

            const db = document.getElementById('daily-btn');
            if(Date.now()/1000 - s.last_daily > 86400) { db.classList.remove('cd'); db.innerText = "üéÅ –ó–ê–ë–†–ê–¢–¨ –ë–û–ù–£–°"; }
            else { db.classList.add('cd'); db.innerText = "‚è≥ –ñ–¥–∏ 24—á"; }
        }

        function drawShop() {
            const hw = document.getElementById('shop-hardware'); const sf = document.getElementById('shop-soft');
            hw.innerHTML = ""; sf.innerHTML = "";

            const psuIdx = s.psu-1;
            addItem(hw, "‚ö° –ë–ª–æ–∫ –ø–∏—Ç–∞–Ω–∏—è", `${psuDB[psuIdx]}W ‚ûî ${psuDB[psuIdx+1]||'MAX'}W`, s.psu, Math.floor(500 * Math.pow(1.5, s.psu)), 'psu');

            const cpuUsed = ((s.multi+1)*10) + (s.mine*20);
            addItem(hw, "üíª –ü—Ä–æ—Ü–µ—Å—Å–æ—Ä", `${cpuDB[s.multi-1]||'Old'} ‚ûî ${cpuDB[s.multi]||'MAX'}`, s.multi, Math.floor(200 * Math.pow(1.5, s.multi)), 'multitap', cpuUsed <= psuDB[s.psu-1]);

            const gpuUsed = (s.multi*10) + ((s.mine+1)*20);
            addItem(hw, "üéÆ –í–∏–¥–µ–æ–∫–∞—Ä—Ç–∞", `${gpuDB[s.mine]||'None'} ‚ûî ${gpuDB[s.mine+1]||'MAX'}`, s.mine, Math.floor(1000 * Math.pow(1.4, s.mine)), 'mining', gpuUsed <= psuDB[s.psu-1]);

            addItem(sf, "üíæ –û–ó–£", `${ramDB[s.ram-1]} ‚ûî ${ramDB[s.ram]}`, s.ram, Math.floor(500 * Math.pow(1.3, s.ram)), 'ram');
            addItem(sf, "üíø –ñ–µ—Å—Ç–∫–∏–π –¥–∏—Å–∫", `${hddDB[s.hdd-1]} ‚ûî ${hddDB[s.hdd]}`, s.hdd, Math.floor(3000 * Math.pow(2.0, s.hdd)), 'hdd');
            addItem(sf, "üìÄ –ú–∞–π–Ω–µ—Ä Soft", s.soft < s.hdd*5 ? "+10% –∫ –¥–æ—Ö–æ–¥—É" : "–ù–£–ñ–ï–ù HDD!", s.soft, Math.floor(5000 * Math.pow(1.8, s.soft)), 'software', s.soft < s.hdd*5);
            addItem(sf, "üîã –ë–∞—Ç–∞—Ä–µ—è", "+500 –ú–∞–∫—Å –≠–Ω–µ—Ä–≥–∏–∏", "", Math.floor(1000 * (s.maxEn/1000)), 'energy');
        }

        function addItem(cont, t, d, l, p, type, ok=true) {
            const el = document.createElement('div'); el.className = 'item';
            let cls = 'btn btn-buy', txt = format(p), act = `buy('${type}', ${p})`;
            if(!ok) { cls='btn btn-lock'; txt='Locked'; } else if(s.bal < p) { cls='btn btn-lock'; }
            el.innerHTML = `<div class="item-left"><h3>${t} <span style="font-size:10px;color:#555">LVL ${l}</span></h3><p>${d} <br><span style="color:#a855f7;font-weight:bold">‚ÇΩ ${txt}</span></p></div><button class="${cls}" onclick="${act}">–ö–£–ü–ò–¢–¨</button>`;
            cont.appendChild(el);
        }

        async function buy(t, p) {
            if(s.bal < p) return;
            s.bal -= p; draw();
            const res = await req('/buy', {type:t, price:p});
            if(res && res.status==='ok') init();
        }

        async function daily() {
            const res = await req('/daily');
            if(res && res.status==='ok') init();
        }

        const btn = document.getElementById('tapBtn');
        btn.addEventListener('pointerdown', (e) => {
            e.preventDefault(); 
            const cost = s.multi; 
            if(s.en >= cost) {
                s.bal += cost; s.en -= cost; queue++; draw();
                const el = document.createElement('div');
                el.className='float'; el.innerText=`+${cost}`;
                el.style.left=e.clientX+'px'; el.style.top=e.clientY-40+'px';
                document.body.appendChild(el);
                setTimeout(()=>el.remove(), 500);
                tg.HapticFeedback.impactOccurred('light');
            }
        });

        setInterval(async()=>{ if(queue>0) { await req('/tap', {clicks:queue}); queue=0; } }, 1500);
        setInterval(()=>{
            s.en = Math.min(s.maxEn, s.en + (1+s.ram*0.5)/5);
            s.bal += (s.mine*5 * (1+s.soft*0.1))/5;
            draw();
        }, 200);

        async function loadTop() {
            const el = document.getElementById('leaderboard');
            el.innerHTML = "<div style='text-align:center;color:#555'>–ó–∞–≥—Ä—É–∑–∫–∞...</div>";
            const d = await req('/leaderboard');
            if(!d) return;
            el.innerHTML = "";
            d.forEach((u,i) => {
                el.innerHTML += `<div class="row"><span class="rank ${i<3?'top':''}">${i+1}</span><span style="font-weight:bold">${u.name}</span><span style="color:#34d399;font-weight:bold">+${format(u.income)}/—á</span></div>`;
            });
            document.getElementById('rank-footer').style.display = 'flex';
            document.getElementById('my-name').innerText = uname;
            document.getElementById('footer-rank').innerText = s.rank;
        }

        function tab(t, btn) {
            document.querySelectorAll('.screen').forEach(e=>e.classList.remove('active'));
            document.getElementById('screen-'+t).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
            btn.classList.add('active');
            if(t==='top') loadTop(); else document.getElementById('rank-footer').style.display = 'none';
            if(t==='shop') drawShop();
        }

        function format(n) {
            if(n>=1000000) return (n/1000000).toFixed(2)+'M';
            if(n>=1000) return (n/1000).toFixed(1)+'k';
            return Math.floor(n);
        }

        init();
    </script>
</body>
</html>
