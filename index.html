<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hardware Tycoon</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: #121212;
            --card: #1e1e1e;
            --gold: #ffcc00;
            --green: #4cd964;
            --blue: #007aff;
            --red: #ff3b30;
            --text: #ffffff;
            --text-sub: #8e8e93;
        }

        body {
            margin: 0; padding: 0; background: var(--bg-color); color: var(--text);
            font-family: -apple-system, sans-serif; height: 100vh; overflow: hidden;
            display: flex; flex-direction: column; user-select: none;
        }

        /* –¢–∞–±—ã */
        .screen { display: none; height: 100%; flex-direction: column; padding: 15px; overflow-y: auto; }
        .screen.active { display: flex; }

        /* HEADER */
        .header {
            display: flex; justify-content: space-between; padding: 10px;
            background: var(--card); border-radius: 15px; margin-bottom: 20px;
        }
        .h-item { text-align: center; width: 33%; }
        .h-lbl { font-size: 10px; color: var(--text-sub); }
        .h-val { font-size: 14px; font-weight: bold; }

        /* –ë–ê–õ–ê–ù–° */
        .balance-box { text-align: center; margin-bottom: 20px; }
        .balance-num { font-size: 42px; font-weight: 800; color: var(--gold); }
        .balance-lbl { font-size: 12px; color: var(--text-sub); }

        /* –¢–ê–ü–ê–õ–ö–ê */
        .tap-area { flex-grow: 1; display: flex; justify-content: center; align-items: center; position: relative; }
        .tap-img {
            width: 260px; height: 260px;
            background-image: url('https://i.imgur.com/8QlqWkH.png');
            background-size: cover; border-radius: 50%;
            border: 5px solid rgba(255,255,255,0.1);
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            transition: transform 0.05s;
        }
        .tap-img:active { transform: scale(0.95); }

        /* –≠–ù–ï–†–ì–ò–Ø */
        .energy-box { margin: 10px 20px; }
        .e-text { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 5px; }
        .e-bar { height: 12px; background: #333; border-radius: 6px; overflow: hidden; }
        .e-fill { height: 100%; background: linear-gradient(90deg, var(--gold), #ff9500); width: 100%; }

        /* –ú–ê–ì–ê–ó–ò–ù */
        .shop-cat { margin-top: 20px; margin-bottom: 10px; font-size: 18px; font-weight: bold; color: var(--blue); }
        .item {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--card); padding: 15px; margin-bottom: 10px; border-radius: 12px;
            border-left: 4px solid transparent;
        }
        .item-info h4 { margin: 0; font-size: 15px; }
        .item-info p { margin: 4px 0 0; font-size: 11px; color: var(--text-sub); }
        .lvl-badge { background: #333; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 5px; }
        
        .buy-btn {
            background: #333; color: #777; border: none; padding: 10px 15px;
            border-radius: 8px; font-weight: bold; font-size: 13px; min-width: 80px;
        }
        .buy-btn.green { background: var(--green); color: #000; cursor: pointer; }
        .buy-btn.red { background: rgba(255, 59, 48, 0.2); color: var(--red); cursor: not-allowed; border: 1px solid var(--red); }

        /* –¢–û–ü */
        .row { display: flex; justify-content: space-between; padding: 15px; border-bottom: 1px solid #333; }
        
        /* –ù–ê–í–ò–ì–ê–¶–ò–Ø */
        .nav {
            display: flex; background: #000; padding: 15px 0 25px; border-top: 1px solid #333;
        }
        .nav-btn { flex: 1; text-align: center; color: #555; font-size: 10px; }
        .nav-btn.active { color: var(--text); }
        .nav-icon { font-size: 22px; display: block; margin-bottom: 4px; }

        .float { position: absolute; color: white; font-weight: bold; font-size: 24px; animation: up 0.8s forwards; pointer-events: none; }
        @keyframes up { to { transform: translateY(-100px); opacity: 0; } }
    </style>
</head>
<body>

    <div id="tab-game" class="screen active">
        <div class="header">
            <div class="h-item">
                <div class="h-lbl">–ë–ü (–í–∞—Ç—Ç)</div>
                <div class="h-val">‚ö° <span id="watt-val">0</span>W</div>
            </div>
            <div class="h-item">
                <div class="h-lbl">–î–æ—Ö–æ–¥/—Å–µ–∫</div>
                <div class="h-val">üí∞ <span id="mine-val">0</span></div>
            </div>
            <div class="h-item">
                <div class="h-lbl">–†–µ–≥–µ–Ω</div>
                <div class="h-val">üîÑ <span id="regen-val">1</span>/—Å</div>
            </div>
        </div>

        <div class="balance-box">
            <div class="balance-num" id="balance">0</div>
            <div class="balance-lbl">ZOLO COINS</div>
        </div>

        <div class="tap-area">
            <div class="tap-img" id="tapBtn"></div>
        </div>

        <div class="energy-box">
            <div class="e-text">
                <span>–≠–Ω–µ—Ä–≥–∏—è</span>
                <span><span id="cur-en">0</span> / <span id="max-en">1000</span></span>
            </div>
            <div class="e-bar"><div class="e-fill" id="e-bar"></div></div>
        </div>
    </div>

    <div id="tab-shop" class="screen">
        <h2 style="text-align:center">–ú–∞–≥–∞–∑–∏–Ω –ñ–µ–ª–µ–∑–∞</h2>
        <div id="shop-list"></div>
    </div>

    <div id="tab-top" class="screen">
        <h2 style="text-align:center">IT –ú–∞–≥–Ω–∞—Ç—ã</h2>
        <div id="leaderboard">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>

    <div class="nav">
        <div class="nav-btn active" onclick="go('game', this)">
            <span class="nav-icon">üñ•Ô∏è</span> –ü–ö
        </div>
        <div class="nav-btn" onclick="go('shop', this)">
            <span class="nav-icon">üõí</span> –ê–ø–≥—Ä–µ–π–¥
        </div>
        <div class="nav-btn" onclick="go('top', this)">
            <span class="nav-icon">üèÜ</span> –¢–æ–ø
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // üëá –¢–í–û–ô URL üëá
        const SERVER_URL = "https://aboba1234.pythonanywhere.com";

        // --- –î–ê–ù–ù–´–ï –û –ö–û–ú–ü–õ–ï–ö–¢–£–Æ–©–ò–• (–ë–ê–ó–ê –ó–ù–ê–ù–ò–ô) ---
        
        // 1. –ü–†–û–¶–ï–°–°–û–†–´ (–ö–ª–∏–∫) - 50 —É—Ä–æ–≤–Ω–µ–π
        const cpuList = [
            {n:"Intel 8086", w:5}, {n:"Intel 286", w:8}, {n:"Intel 386", w:10}, {n:"Intel 486", w:15},
            {n:"Pentium I", w:20}, {n:"Pentium MMX", w:25}, {n:"Pentium Pro", w:30}, {n:"Pentium II", w:35},
            {n:"Celeron 300A", w:35}, {n:"Pentium III", w:40}, {n:"Athlon K7", w:50}, {n:"Pentium 4", w:80},
            {n:"Athlon 64", w:85}, {n:"Pentium D", w:130}, {n:"Core 2 Duo", w:65}, {n:"Core 2 Quad", w:95},
            {n:"Phenom II X4", w:125}, {n:"Core i7 920", w:130}, {n:"Core i5 2500K", w:95}, {n:"FX-8350", w:140},
            {n:"Core i7 4790K", w:88}, {n:"Ryzen 7 1700", w:65}, {n:"Core i9 9900K", w:150}, {n:"Ryzen 9 3950X", w:160},
            {n:"Core i9 12900K", w:240}, {n:"Ryzen 9 7950X", w:230}, {n:"Threadripper", w:350}, {n:"Epyc Rome", w:400},
            {n:"Xeon Platinum", w:500}, {n:"Apple M1 Ultra", w:100}, {n:"Quantum Bit 1", w:600}, {n:"Quantum Bit 5", w:700},
            {n:"Neuro Chip v1", w:800}, {n:"Neuro Chip v2", w:900}, {n:"Bio-Processor", w:1000}, {n:"Plasma Core", w:1200},
            {n:"Photon CPU", w:1500}, {n:"Antimatter Core", w:2000}, {n:"Black Hole Chip", w:3000}, {n:"God Particle", w:5000}
        ]; // –î–æ–ø–æ–ª–Ω–∏–ª –¥–æ 40 –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞

        // 2. –í–ò–î–ï–û–ö–ê–†–¢–´ (–ú–∞–π–Ω–∏–Ω–≥)
        const gpuList = [
            {n:"CGA Graphics", w:5}, {n:"EGA", w:10}, {n:"VGA", w:15}, {n:"S3 Trio", w:20},
            {n:"3dfx Voodoo", w:30}, {n:"Riva TNT2", w:35}, {n:"GeForce 256", w:40}, {n:"Radeon 8500", w:45},
            {n:"GeForce 4 Ti", w:50}, {n:"Radeon 9800 Pro", w:60}, {n:"GeForce 6800 Ultra", w:80}, {n:"GeForce 8800 GTX", w:150},
            {n:"HD 5870", w:180}, {n:"GTX 480 (Grill)", w:300}, {n:"GTX 690", w:300}, {n:"R9 290X", w:290},
            {n:"GTX 980 Ti", w:250}, {n:"GTX 1080 Ti", w:250}, {n:"RTX 2080 Ti", w:260}, {n:"RTX 3090", w:350},
            {n:"RTX 4090", w:450}, {n:"RTX 5090", w:600}, {n:"H100 Cluster", w:700}, {n:"Tesla Dojo", w:1000},
            {n:"Mining Rig v1", w:1200}, {n:"Mining Rig v2", w:1500}, {n:"AI Farm", w:2000}, {n:"Matrix Render", w:3000},
            {n:"Simulation GPU", w:5000}
        ];

        // 3. –ë–õ–û–ö–ò –ü–ò–¢–ê–ù–ò–Ø (–õ–∏–º–∏—Ç –í–∞—Ç—Ç)
        const psuList = [
            {n:"–ö–∞—Ä—Ç–æ—Ñ–µ–ª–∏–Ω–∞", p:15}, {n:"–ë–∞—Ç–∞—Ä–µ–π–∫–∞ AA", p:30}, {n:"NoName 200W", p:200}, {n:"Office 300W", p:300},
            {n:"Bronze 450W", p:450}, {n:"Silver 600W", p:600}, {n:"Gold 750W", p:750}, {n:"Platinum 1000W", p:1000},
            {n:"Titanium 1600W", p:1600}, {n:"Server PSU 2kW", p:2000}, {n:"Industrial 5kW", p:5000}, {n:"Substation", p:10000},
            {n:"Nuclear Reactor", p:50000}, {n:"Dyson Sphere", p:999999}
        ];

        // 4. –û–ó–£ (–†–µ–≥–µ–Ω —ç–Ω–µ—Ä–≥–∏–∏)
        const ramList = [
            {n:"DIP Switch", spd:"+0.5"}, {n:"SIP Memory", spd:"+1"}, {n:"SIMM 30-pin", spd:"+1.5"}, {n:"SIMM 72-pin", spd:"+2"},
            {n:"DIMM SDRAM", spd:"+3"}, {n:"DDR1 266", spd:"+4"}, {n:"DDR2 800", spd:"+5"}, {n:"DDR3 1600", spd:"+7"},
            {n:"DDR4 3200", spd:"+10"}, {n:"DDR5 6000", spd:"+15"}, {n:"HBM2", spd:"+20"}, {n:"HBM3e", spd:"+30"},
            {n:"Crystalline", spd:"+50"}, {n:"DNA Storage", spd:"+100"}
        ];

        // --- –õ–û–ì–ò–ö–ê ---
        const user = tg.initDataUnsafe.user;
        const userId = user ? user.id : 123;
        // –ë–ï–†–ï–ú –ü–û–õ–ù–û–ï –ò–ú–Ø
        const fullName = user ? `${user.first_name} ${user.last_name || ''}`.trim() : "Unknown User";
        const startParam = tg.initDataUnsafe.start_param || null;

        let state = { bal:0, en:1000, maxEn:1000, multi:1, mine:0, ram:1, psu:1 };
        let clicks = 0;
        let failCount = 0;

        async function req(ep, body={}) {
            try {
                const r = await fetch(SERVER_URL + ep, {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({user_id:userId, username:fullName, ...body})
                });
                if(r.status===400) { tg.showAlert((await r.json()).error); return null; }
                failCount=0;
                return await r.json();
            } catch(e) {
                failCount++;
                if(failCount>3) tg.showAlert("–°–≤—è–∑—å –ø–æ—Ç–µ—Ä—è–Ω–∞...");
                return null;
            }
        }

        async function init() {
            const d = await req('/api/init', {start_param:startParam});
            if(d) {
                state = {
                    bal: d.balance, en: d.energy, maxEn: d.max_energy,
                    multi: d.multitap, mine: d.mining, ram: d.ram, psu: d.psu
                };
                render();
                renderShop();
                if(d.profit_afk > 0) tg.showAlert(`–ú–∞–π–Ω–∏–Ω–≥ –æ—Ñ—Ñ–ª–∞–π–Ω: +${d.profit_afk}`);
            }
        }

        // --- UI RENDER ---
        function render() {
            document.getElementById('balance').innerText = Math.floor(state.bal).toLocaleString();
            document.getElementById('cur-en').innerText = Math.floor(state.en);
            document.getElementById('max-en').innerText = state.maxEn;
            document.getElementById('e-bar').style.width = (state.en / state.maxEn * 100) + "%";
            
            // –†–∞—Å—á–µ—Ç –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è –≤–∞—Ç—Ç
            const curCpuW = cpuList[state.multi-1]?.w || 0;
            const curGpuW = gpuList[state.mine]?.w || 0; // mine=0 means no gpu usually
            const usedW = curCpuW + curGpuW;
            const maxW = psuList[state.psu-1]?.p || 15;
            
            document.getElementById('watt-val').innerText = `${usedW} / ${maxW}`;
            document.getElementById('watt-val').style.color = (usedW > maxW) ? '#ff3b30' : '#4cd964';
            
            document.getElementById('mine-val').innerText = (state.mine * 5).toLocaleString(); // —É—Å–ª–æ–≤–Ω–æ
            document.getElementById('regen-val').innerText = (1 + state.ram*0.5).toFixed(1);
        }

        function renderShop() {
            const list = document.getElementById('shop-list');
            list.innerHTML = "";

            // 1. –ë–ê–¢–ê–†–ï–Ø
            const enPrice = Math.floor(500 * (state.maxEn/500));
            addShopItem(list, "üîã –ê–∫–∫—É–º—É–ª—è—Ç–æ—Ä", "–£–≤–µ–ª–∏—á–∏—Ç—å –º–∞–∫—Å. —ç–Ω–µ—Ä–≥–∏—é +500", `–¢–µ–∫—É—â–∞—è: ${state.maxEn}`, enPrice, 'energy');

            // 2. PSU
            const nextPsuIdx = state.psu;
            if(nextPsuIdx < psuList.length) {
                const p = psuList[nextPsuIdx];
                const price = 500 * (nextPsuIdx+1);
                addShopItem(list, "‚ö° –ë–ª–æ–∫ –ø–∏—Ç–∞–Ω–∏—è", `${p.n} (${p.p}W)`, `–£—Ä. ${state.psu}`, price, 'psu');
            }

            // 3. RAM
            const nextRamIdx = state.ram;
            if(nextRamIdx < ramList.length) {
                const r = ramList[nextRamIdx];
                const price = 400 * nextRamIdx;
                addShopItem(list, "üíæ –û–ó–£ (–†–µ–≥–µ–Ω)", `${r.n} (–°–∫–æ—Ä–æ—Å—Ç—å ${r.spd})`, `–£—Ä. ${state.ram}`, price, 'ram');
            }

            // 4. CPU
            const nextCpuIdx = state.multi;
            if(nextCpuIdx < cpuList.length) {
                const c = cpuList[nextCpuIdx];
                const price = 200 * Math.pow(1.2, nextCpuIdx);
                const psuCap = psuList[state.psu-1].p;
                const currentLoad = (gpuList[state.mine]?.w || 0) + (cpuList[state.multi-1]?.w || 0);
                const neededW = (c.w - (cpuList[state.multi-1]?.w || 0)) + currentLoad; // –ü—Ä–æ–≥–Ω–æ–∑
                
                // –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –•–≤–∞—Ç–∞–µ—Ç –ª–∏ –ë–ü –Ω–∞ –ù–û–í–´–ô –ø—Ä–æ—Ü + –°–¢–ê–†–£–Æ –≤–∏–¥—é—Ö—É
                const totalNeed = c.w + (gpuList[state.mine]?.w || 0);
                const psuOk = totalNeed <= psuCap;

                addShopItem(list, "üñ•Ô∏è –ü—Ä–æ—Ü–µ—Å—Å–æ—Ä", `${c.n} (+–ö–ª–∏–∫, ${c.w}W)`, `–£—Ä. ${state.multi}`, Math.floor(price), 'multitap', psuOk);
            }

            // 5. GPU
            const nextGpuIdx = state.mine + 1; // –£ –Ω–∞—Å mining_level 0 = –Ω–µ—Ç –∫–∞—Ä—Ç—ã
            if(nextGpuIdx < gpuList.length) {
                const g = gpuList[nextGpuIdx];
                const price = 1000 * Math.pow(1.3, nextGpuIdx);
                
                const psuCap = psuList[state.psu-1].p;
                const totalNeed = g.w + (cpuList[state.multi-1]?.w || 0);
                const psuOk = totalNeed <= psuCap;

                addShopItem(list, "üéÆ –í–∏–¥–µ–æ–∫–∞—Ä—Ç–∞", `${g.n} (+–î–æ—Ö–æ–¥, ${g.w}W)`, `–£—Ä. ${state.mine}`, Math.floor(price), 'mining', psuOk);
            }
        }

        function addShopItem(container, title, desc, badge, price, type, psuOk = true) {
            const div = document.createElement('div');
            div.className = 'item';
            
            // –ï—Å–ª–∏ –ë–ü –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç
            let btnClass = 'buy-btn green';
            let btnText = price.toLocaleString();
            let onclick = `buy('${type}', ${price})`;

            if (!psuOk) {
                btnClass = 'buy-btn red';
                btnText = "–ù—É–∂–µ–Ω –ë–ü!";
                onclick = "";
            } else if (state.bal < price) {
                btnClass = 'buy-btn'; // —Å–µ—Ä—ã–π
                onclick = `tg.showAlert('–ù–µ—Ç –¥–µ–Ω–µ–≥!')`;
            }

            div.innerHTML = `
                <div class="item-info">
                    <h4>${title} <span class="lvl-badge">${badge}</span></h4>
                    <p>${desc}</p>
                </div>
                <button class="${btnClass}" onclick="${onclick}">${btnText}</button>
            `;
            container.appendChild(div);
        }

        async function buy(type, price) {
            if(state.bal < price) return;
            const res = await req('/api/buy', {type:type, price:price});
            if(res && res.status==='ok') init();
        }

        // --- –ì–ï–ô–ú–ü–õ–ï–ô ---
        document.getElementById('tapBtn').addEventListener('click', (e) => {
            // –≠–Ω–µ—Ä–≥–∏—è —Ç—Ä–∞—Ç–∏—Ç—Å—è = –£—Ä–æ–≤–Ω—é –∫–ª–∏–∫–∞ (–°–∏–ª–∞ –∫–ª–∏–∫–∞)
            const cost = state.multi;
            
            if(state.en >= cost) {
                state.bal += state.multi;
                state.en -= cost;
                clicks++;
                render();
                
                // –ê–Ω–∏–º–∞—Ü–∏—è
                const f = document.createElement('div');
                f.className='float'; f.innerText='+'+state.multi;
                f.style.left = e.clientX+'px'; f.style.top = e.clientY-50+'px';
                document.body.appendChild(f);
                setTimeout(()=>f.remove(),800);
                
                tg.HapticFeedback.impactOccurred('light');
            } else {
                tg.HapticFeedback.notificationOccurred('error');
            }
        });

        // –û—Ç–ø—Ä–∞–≤–∫–∞
        setInterval(async()=>{
            if(clicks>0) {
                await req('/api/tap', {clicks:clicks});
                clicks=0;
            }
        }, 2000);

        // –†–µ–≥–µ–Ω —ç–Ω–µ—Ä–≥–∏–∏ + –ü–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥ (–í–∏–∑—É–∞–ª—å–Ω–æ)
        setInterval(()=>{
            // –†–µ–≥–µ–Ω: 1 + 0.5 –∑–∞ —É—Ä–æ–≤–µ–Ω—å –û–ó–£
            const regen = 1 + (state.ram * 0.5);
            if(state.en < state.maxEn) {
                state.en = Math.min(state.maxEn, state.en + regen);
            }
            // –î–æ—Ö–æ–¥: 1 —É—Ä –º–∞–π–Ω–∏–Ω–≥–∞ = ~5 –º–æ–Ω–µ—Ç/—Å–µ–∫ (–ø—Ä–∏–º–µ—Ä–Ω–æ)
            if(state.mine > 0) {
                state.bal += (state.mine * 0.2); // –≤–∏–∑—É–∞–ª—å–Ω–æ–µ –ø–ª–∞–≤–Ω–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ
            }
            render();
        }, 200); // 5 —Ä–∞–∑ –≤ —Å–µ–∫—É–Ω–¥—É –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏

        // –¢–æ–ø
        async function loadTop() {
            const d = await req('/api/leaderboard');
            const el = document.getElementById('leaderboard');
            el.innerHTML = "";
            d.forEach((u,i) => {
                el.innerHTML += `<div class="row"><b>#${i+1} ${u.name}</b> <span>${u.balance.toLocaleString()}</span></div>`;
            });
        }

        function go(tab, btn) {
            document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
            document.getElementById('tab-'+tab).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
            btn.classList.add('active');
            if(tab==='top') loadTop();
            if(tab==='shop') renderShop(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å –º–∞–≥–∞–∑–∏–Ω (–æ–±–Ω–æ–≤–∏—Ç—å —Ü–µ–Ω—ã/–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å)
        }

        init();
    </script>
</body>
</html>

